# ==============================================================================
# UltraShape 1.0 Dockerfile
# åŸºäº PKU-YuanGroup/UltraShape-1.0 (https://github.com/PKU-YuanGroup/UltraShape-1.0)
# ç”¨äºé«˜ä¿çœŸ 3D å‡ ä½•ç»†åŒ– - å¯ä½œä¸ºä»»ä½• 3D é‡å»ºæ¨¡å‹çš„åå¤„ç†å™¨
# ==============================================================================

FROM nvidia/cuda:12.1.0-devel-ubuntu22.04

# åŸºç¡€ç¯å¢ƒé…ç½®
ENV DEBIAN_FRONTEND=noninteractive \
    PYTHONUNBUFFERED=1 \
    PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apt-get update && apt-get install -y \
    git \
    wget \
    curl \
    python3.10 \
    python3-pip \
    python3.10-dev \
    build-essential \
    libgl1-mesa-glx \
    libglib2.0-0 \
    && rm -rf /var/lib/apt/lists/*

# åˆ›å»ºå·¥ä½œç›®å½•
WORKDIR /opt/ultrashape

# å…‹éš† UltraShape ä»“åº“
RUN git clone https://github.com/PKU-YuanGroup/UltraShape-1.0.git . && \
    echo "âœ“ UltraShape ä»“åº“å…‹éš†å®Œæˆ"

# å‡çº§ pip
RUN pip3 install --upgrade pip setuptools wheel

# å®‰è£… PyTorch (CUDA 12.1)
RUN pip3 install torch==2.5.1 torchvision==0.20.1 torchaudio==2.5.1 \
    --index-url https://download.pytorch.org/whl/cu121 && \
    echo "âœ“ PyTorch 2.5.1 å®‰è£…å®Œæˆ"

# å®‰è£… UltraShape ä¾èµ–
RUN pip3 install --no-build-isolation -r requirements.txt && \
    echo "âœ“ UltraShape ä¾èµ–å®‰è£…å®Œæˆ"

# å®‰è£… cubvh (Marching Cubes åŠ é€Ÿ)
RUN pip3 install git+https://github.com/ashawkey/cubvh --no-build-isolation && \
    echo "âœ“ cubvh å®‰è£…å®Œæˆ"

# å¯é€‰ï¼šå®‰è£…è®­ç»ƒä¾èµ–ï¼ˆå¦‚æœéœ€è¦è®­ç»ƒæˆ–æ•°æ®å¤„ç†ï¼‰
# RUN pip3 install --no-build-isolation "git+https://github.com/facebookresearch/pytorch3d.git@stable"
# RUN pip3 install https://data.pyg.org/whl/torch-2.5.0%2Bcu121/torch_cluster-1.6.3%2Bpt25cu121-cp310-cp310-linux_x86_64.whl
# ===================================================================
# æ¨¡å‹æƒé‡ä¸‹è½½ç­–ç•¥
# ===================================================================
# æ–¹å¼ 1:æ„å»ºæ—¶è‡ªåŠ¨ä¸‹è½½(éœ€è¦ git-lfs,æ„å»ºæ—¶é—´é•¿)
# RUN apt-get update && apt-get install -y git-lfs && \
#     git lfs install && \
#     git lfs clone https://huggingface.co/infinith/UltraShape /tmp/weights && \
#     mkdir -p /workspace/checkpoints && \
#     cp /tmp/weights/*.pt /workspace/checkpoints/ && \
#     rm -rf /tmp/weights

# æ–¹å¼ 2:è¿è¡Œæ—¶æŒ‚è½½(æ¨è,çµæ´»)
# åœ¨ docker-compose.yml ä¸­æŒ‚è½½æœ¬åœ°æƒé‡:
# volumes:
#   - ./models/ultrashape:/workspace/checkpoints:ro
# 
# æ‰‹åŠ¨ä¸‹è½½å‘½ä»¤:
# git lfs clone https://huggingface.co/infinith/UltraShape models/ultrashape

# åˆ›å»ºæƒé‡ç›®å½•å ä½ç¬¦
RUN mkdir -p /workspace/checkpoints && \
    echo "è¯·å°† ultrashape_v1.pt æ”¾ç½®åœ¨æ­¤ç›®å½•" > /workspace/checkpoints/README.txt
# ===================================================================
# éªŒè¯å®‰è£…
RUN python3 -c "import torch; print(f'PyTorch {torch.__version__} (CUDA: {torch.cuda.is_available()})')" && \
    python3 -c "from ultrashape.pipelines import UltraShapePipeline; print('âœ“ UltraShape æ¨¡å—åŠ è½½æˆåŠŸ')"

# åˆ›å»ºå¿…è¦ç›®å½•
RUN mkdir -p /workspace/outputs /workspace/checkpoints /workspace/test_images

# å¤åˆ¶ Cortex3d é›†æˆè„šæœ¬(åœ¨å®¹å™¨å¯åŠ¨æ—¶ä»æŒ‚è½½å·è·å–)
# æ³¨æ„: scripts ç›®å½•é€šè¿‡ docker-compose.yml æŒ‚è½½

# å·¥ä½œç›®å½•
WORKDIR /workspace

# æš´éœ² Gradio ç«¯å£
EXPOSE 7860

# å…¥å£è„šæœ¬(æ£€æŸ¥æƒé‡å¹¶å¯åŠ¨)
RUN echo '#!/bin/bash\n\
set -e\n\
echo "ğŸš€ å¯åŠ¨ UltraShape å®¹å™¨..."\n\
if [ ! -f "/workspace/checkpoints/ultrashape_v1.pt" ]; then\n\
    echo ""\n\
    echo "âš ï¸  é”™è¯¯:æ¨¡å‹æƒé‡æœªæ‰¾åˆ°!"\n\
    echo ""\n\
    echo "è¯·ä¸‹è½½æ¨¡å‹æƒé‡:"\n\
    echo "  æ–¹å¼ 1(æ¨è): git lfs clone https://huggingface.co/infinith/UltraShape models/ultrashape"\n\
    echo "  æ–¹å¼ 2: è®¿é—® https://huggingface.co/infinith/UltraShape/tree/main"\n\
    echo "         ä¸‹è½½ ultrashape_v1.pt åˆ° models/ultrashape/"\n\
    echo ""\n\
    echo "ç„¶åé‡æ–°å¯åŠ¨å®¹å™¨: docker compose up ultrashape"\n\
    echo ""\n\
    exit 1\n\
fi\n\
echo "âœ“ æ¨¡å‹æƒé‡å·²åŠ è½½"\n\
echo "ğŸ¨ å¯åŠ¨ Gradio UI: http://localhost:7863"\n\
exec "$@"\n\
' > /entrypoint.sh && chmod +x /entrypoint.sh

# é»˜è®¤å‘½ä»¤:å¯åŠ¨ Gradio UI(å®˜æ–¹è‡ªå¸¦ç•Œé¢)
ENTRYPOINT ["/entrypoint.sh"]
CMD ["python3", "/opt/ultrashape/scripts/gradio_app.py", \
     "--ckpt", "/workspace/checkpoints/ultrashape_v1.pt"]
