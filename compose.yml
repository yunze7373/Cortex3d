services:
  instantmesh:
    build:
      context: .
      dockerfile: Dockerfile
    image: cortex3d-instantmesh:latest
    container_name: cortex3d-dev
    working_dir: /workspace
    volumes:
      - ./:/workspace
      - hf-cache:/root/.cache/huggingface
    shm_size: "8gb"
    stdin_open: true
    tty: true
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

  trellis:
    build:
      context: .
      dockerfile: Dockerfile.trellis
    image: cortex3d-trellis:latest
    container_name: cortex3d-trellis
    working_dir: /workspace
    volumes:
      - ./:/workspace
      - hf-cache:/root/.cache/huggingface
    shm_size: "16gb"
    stdin_open: true
    tty: true
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

  hunyuan3d:
    build:
      context: .
      dockerfile: Dockerfile.hunyuan3d
    image: cortex3d-hunyuan3d:latest
    container_name: cortex3d-hunyuan3d
    working_dir: /workspace
    volumes:
      - ./:/workspace
      - hf-cache:/root/.cache/huggingface
    shm_size: "16gb"
    stdin_open: true
    tty: true
    environment:
      - HUNYUAN3D_VERSION=2.0
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

  hunyuan3d-2.1:
    build:
      context: .
      dockerfile: Dockerfile.hunyuan3d-2.1
    image: cortex3d-hunyuan3d-2.1:latest
    container_name: cortex3d-hunyuan3d-2.1
    working_dir: /workspace
    volumes:
      - ./:/workspace
      - hf-cache:/root/.cache/huggingface
    shm_size: "16gb"
    stdin_open: true
    tty: true
    environment:
      - HUNYUAN3D_VERSION=2.1
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

  trellis2:
    build:
      context: .
      dockerfile: Dockerfile.trellis2
    image: cortex3d-trellis2:latest
    container_name: cortex3d-trellis2
    working_dir: /workspace
    volumes:
      - ./:/workspace
      - hf-cache:/root/.cache/huggingface
      - ./patches/trellis2/config.py:/opt/trellis2/trellis2/modules/sparse/config.py
      - ./patches/trellis2/full_attn.py:/opt/trellis2/trellis2/modules/sparse/attention/full_attn.py
    shm_size: "24gb"
    stdin_open: true
    tty: true
    environment:
      - PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True
      - OPENCV_IO_ENABLE_OPENEXR=1
      - TORCH_CUDA_ARCH_LIST=8.6;8.9;9.0
      - CUDA_VISIBLE_DEVICES=0
      - ATTN_BACKEND=sdpa
      - SPCONV_ALGO=native
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

  hunyuan3d-omni:
    build:
      context: .
      dockerfile: Dockerfile.hunyuan3d-omni
    image: cortex3d-hunyuan3d-omni:latest
    container_name: cortex3d-hunyuan3d-omni
    working_dir: /workspace
    volumes:
      - ./:/workspace
      - hf-cache:/root/.cache/huggingface
    shm_size: "16gb"
    stdin_open: true
    tty: true
    environment:
      - HUNYUAN3D_VERSION=omni
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

  # UltraShape Service (Universal Geometry Refiner)
  # 可细化任何模型的输出：InstantMesh、TripoSR、TRELLIS.2、Hunyuan3D 等
  ultrashape:
    build:
      context: .
      dockerfile: Dockerfile.ultrashape
    image: cortex3d-ultrashape:latest
    container_name: cortex3d-ultrashape
    working_dir: /workspace
    volumes:
      - ./:/workspace
      - ./models/ultrashape:/workspace/checkpoints:ro
      - hf-cache:/root/.cache/huggingface
    shm_size: "16gb"
    stdin_open: true
    tty: true
    ports:
      - "7863:7860"
    environment:
      - PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True
      - PYTHONPATH=/opt/ultrashape
    # 覆盖默认命令，启用局域网访问（无需重新 build）
    command: >
      /entrypoint.sh sh -c "cd /opt/ultrashape && python3 scripts/gradio_app.py
      --ckpt /workspace/checkpoints/ultrashape_v1.pt"
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

  # ==========================================================================
  # Z-Image-Turbo (阿里巴巴通义 - 开源第一的图像生成模型)
  # 6B参数，8步推理，16GB VRAM，中英文双语支持
  # ==========================================================================
  zimage:
    build:
      context: .
      dockerfile: Dockerfile.zimage
    image: cortex3d-zimage:latest
    container_name: cortex3d-zimage
    working_dir: /workspace
    volumes:
      - ./scripts:/workspace/scripts:ro
      - ./outputs:/workspace/outputs
      - hf-cache:/root/.cache/huggingface
    shm_size: "16gb"
    stdin_open: true
    tty: true
    ports:
      - "8199:8199"
    environment:
      - HF_TOKEN=${HF_TOKEN}
      - CUDA_VISIBLE_DEVICES=0
      - PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True
    restart: unless-stopped
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

volumes:
  hf-cache:

